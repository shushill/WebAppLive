name: Deploy Dashboard to K3s

on:
  push:
    paths:
      - 'infra/dashboard/**'
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (needed for git clone inside SSH)
        uses: actions/checkout@v4

      - name: Deploy via SSH to K3s VM
        uses: appleboy/ssh-action@v1.6.0
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_PRIVATE_KEY }}
          script: |
            # Set K3s kubeconfig path
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
            
            # Create deployment folder if missing
            mkdir -p ~/springboot-k3s-deployment
            cd ~/springboot-k3s-deployment
            
            # Clone repo if not exists, else pull latest changes
            if [ ! -d ".git" ]; then
              git clone https://github.com/shushill/WebAppLive .
            else
              git reset --hard
              git pull origin master
            fi
            
            # Upgrade or install Helm chart
            helm upgrade --install dashboard-access ./infra/dashboard -n kubernetes-dashboard
